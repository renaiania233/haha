<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHS PROD Gestion Stock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
	<script src="https://unpkg.com/@ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 18px;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        a {
            color: inherit;
            text-decoration: none;
        }
        
        button, input, select, textarea {
            font-family: inherit;
            font-size: 1.1rem;
        }
        
        h1, h2, h3 {
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        /* Styles pour le syst√®me de licence */
        .license-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            text-align: center;
        }
        
        .license-title {
            font-size: 2.2rem;
            margin-bottom: 25px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .license-message {
            font-size: 1.2rem;
            margin-bottom: 30px;
            line-height: 1.7;
        }
        
        .license-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .license-input {
            padding: 16px 20px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 12px;
            width: 100%;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .license-input:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
        }
        
        .license-btn {
            padding: 16px 30px;
            font-size: 1.3rem;
            border-radius: 12px;
            cursor: pointer;
            background: #4a90e2;
            color: white;
            border: none;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .license-btn:hover {
            background: #3a7bc8;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .license-error {
            color: #d9534f;
            margin-top: 15px;
            font-size: 1.1rem;
            display: none;
        }
        
        .license-success {
            color: #28a745;
            margin-top: 15px;
            font-size: 1.2rem;
            display: none;
        }
        
        .license-contact {
            margin-top: 35px;
            font-size: 1.1rem;
            border-top: 1px solid #eee;
            padding-top: 25px;
        }
        
        .license-contact a {
            color: #4a90e2;
            font-weight: bold;
            text-decoration: none;
        }
        
        .license-contact a:hover {
            text-decoration: underline;
        }
        
        .app-container {
            display: none;
        }
        
        /* Styles existants de l'application */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #4a90e2;
            color: #fff;
            padding: 15px 25px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
        }
        
        .logo-container img {
            height: 60px;
            width: 60px;
            border-radius: 50%;
            border: 3px solid #fff;
        }
        
        .nav-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
        }
        
        nav {
            display: flex;
            gap: 15px;
            font-size: 1.2rem;
            flex-wrap: wrap;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        nav button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 12px 20px;
            border-radius: 8px;
            white-space: nowrap;
            font-size: 1.1rem;
            transition: all 0.3s;
            min-width: 140px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        nav button.active, nav button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        main {
            flex: 1;
            padding: 25px;
            padding-top: 100px;
            padding-bottom: 120px;
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #2c3e50;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90e2;
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            margin: 8px 0;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 140px;
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: #4a90e2;
            color: #fff;
        }
        
        .btn-secondary {
            background: #7b7b7b;
            color: #fff;
        }
        
        .btn-success {
            background: #28a745;
            color: #fff;
        }
        
        .btn-danger {
            background: #dc3545;
            color: #fff;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            font-size: 1.2rem;
            color: #2c3e50;
        }
        
        .form-control {
            padding: 14px;
            font-size: 1.1rem;
            margin: 8px 0;
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: #4a90e2;
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row > * {
            flex: 1;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
        }
        
        th, td {
            padding: 18px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
        }
        
        th {
            background: #e0e0e0;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f7ff;
        }
        
        .table-actions {
            display: flex;
            gap: 12px;
        }
        
        footer {
            background: #4a90e2;
            color: #fff;
            text-align: center;
            padding: 20px;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 1.1rem;
            box-shadow: 0 -3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        footer a {
            font-weight: bold;
            text-decoration: underline;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.2s, opacity 0.2s;
            z-index: 2000;
        }
        
        .modal.active {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        
        .modal-content {
            background: #fff;
            padding: 35px;
            border-radius: 18px;
            max-width: 750px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .modal-content h2 {
            margin-bottom: 25px;
            font-size: 1.8rem;
            color: #4a90e2;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            font-size: 2rem;
            color: #888;
            transition: color 0.3s;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            color: #333;
            background: #f5f5f5;
            border-radius: 50%;
        }
        
        .scanner-container {
            position: relative;
            margin: 25px 0;
            width: 100%;
            height: 60vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        #video-preview, #vente-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            background: #000;
            margin-top: 15px;
        }
        
        #scan-result, #modal-scan-result, #modal-vente-result {
            margin-top: 20px;
            font-size: 1.3rem;
            word-break: break-all;
            padding: 18px;
            background: #f1f7ff;
            border-radius: 10px;
            text-align: center;
        }
        
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 40%;
            border: 5px solid #4a90e2;
            border-radius: 18px;
            pointer-events: none;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        .scanner-animation {
            position: absolute;
            top: 0;
            left: 10%;
            width: 80%;
            height: 5px;
            background: #4a90e2;
            animation: scan 2s infinite linear;
            z-index: 20;
        }
        
        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }
        
        .vente-ligne {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 18px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }
        
        .vente-info {
            flex: 1;
            min-width: 220px;
            font-size: 1.2rem;
        }
        
        .vente-qty {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .vente-actions {
            display: flex;
            gap: 12px;
        }
        
        .vente-total {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 25px 0;
            text-align: right;
            padding: 15px;
            background: #f1f7ff;
            border-radius: 12px;
        }
        
        .alert {
            padding: 18px;
            border-radius: 10px;
            margin: 18px 0;
            font-size: 1.2rem;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0,0,0,0.6);
            padding: 10px 15px;
            border-radius: 30px;
            z-index: 100;
        }
        
        .zoom-btn {
            background: #4a90e2;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .performance-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-collapsed {
            max-height: 0;
            overflow: hidden;
            padding: 0;
        }
        
        .nav-expanded {
            max-height: 500px;
            padding: 15px 0;
        }
        
        .today-date {
            background: #f1f7ff;
            padding: 10px 15px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .auto-calc {
            background-color: #f0f8ff;
            border: 1px dashed #4a90e2;
        }
        
        .camera-status {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: #666;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.7);
            z-index: 50;
            color: white;
            font-size: 1.2rem;
            text-align: center;
            padding: 20px;
        }
        
        .scanner-overlay.hidden {
            display: none;
        }
        
        @media (max-width: 1024px) {
            header {
                flex-wrap: wrap;
            }
            
            .logo-container {
                order: 1;
                flex: 1;
            }
            
            .nav-toggle {
                display: block;
                order: 2;
            }
            
            nav {
                order: 3;
                width: 100%;
                flex-direction: column;
                gap: 10px;
                max-height: 0;
                overflow: hidden;
                padding: 0;
            }
            
            nav button {
                min-width: 100%;
                text-align: center;
            }
            
            .nav-expanded {
                max-height: 500px;
                padding: 15px 0;
            }
        }
        
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .vente-ligne {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .scanner-container {
                height: 50vh;
            }
        }
        
        @media (max-width: 480px) {
            .scanner-container {
                height: 40vh;
            }
            
            .scanner-frame {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- √âcran d'activation de licence -->
    <div id="license-screen" class="license-container">
        <h1 class="license-title">
            <i class="fas fa-key"></i> Activation de Licence
        </h1>
        
        <p class="license-message">
            Bienvenue dans GHS PROD Gestion Stock. Pour utiliser cette application,
            veuillez entrer votre cl√© de licence ci-dessous. Si vous n'avez pas encore
            de licence, contactez-nous pour en obtenir une.
        </p>
        
        <div class="license-form">
            <input type="text" id="license-key" class="license-input" 
                   placeholder="XXXX-XXXX-XXXX-XXXX" maxlength="19">
            
            <button id="activate-btn" class="license-btn">
                <i class="fas fa-check-circle"></i> Activer la Licence
            </button>
            
            <div id="license-error" class="license-error">
                <i class="fas fa-exclamation-circle"></i> Cl√© de licence invalide. 
                Veuillez v√©rifier et r√©essayer.
            </div>
            
            <div id="license-success" class="license-success">
                <i class="fas fa-check-circle"></i> Licence activ√©e avec succ√®s !
                Redirection en cours...
            </div>
        </div>
        
        <div class="license-contact">
            <p>Besoin d'aide ? Contactez-nous :</p>
            <p>
                <i class="fab fa-whatsapp"></i> <a href="https://wa.me/0676330935" target="_blank">0676330935</a> | 
                <i class="fab fa-instagram"></i> <a href="https://www.instagram.com/ghilas.yah" target="_blank">@ghilas.yah</a>
            </p>
        </div>
    </div>
    
    <!-- Application principale (masqu√©e jusqu'√† activation) -->
    <div id="app-container" class="app-container">
        <header>
            <div class="logo-container">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234a90e2'/%3E%3Ctext x='50' y='55' font-size='30' text-anchor='middle' fill='white' font-family='Arial'%3EGHS%3C/text%3E%3C/svg%3E" alt="Logo">
                <span>GHS PROD Gestion Stock</span>
            </div>
            
            <button class="nav-toggle" id="nav-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <nav id="main-nav">
                <button id="nav-accueil" class="active"><i class="fas fa-home"></i> Accueil</button>
                <button id="nav-stock"><i class="fas fa-box"></i> Stock</button>
                <button id="nav-scanner"><i class="fas fa-camera"></i> Scanner</button>
                <button id="nav-ventes"><i class="fas fa-shopping-cart"></i> Ventes</button>
                <button id="nav-historique"><i class="fas fa-history"></i> Historique</button>
                <button id="nav-fournisseurs"><i class="fas fa-truck"></i> Fournisseurs</button>
            </nav>
        </header>
        
        <main>
            <!-- ACCUEIL -->
            <section id="accueil" class="section active">
                <h1><i class="fas fa-chart-line"></i> Tableau de Bord</h1>
                <div class="today-date">
                    <i class="fas fa-calendar"></i> Date: <span id="current-date"></span>
                </div>
                <div class="card-container">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-tags"></i> Nombre de produits</div>
                        <div class="card-value" id="stat-produits">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-money-bill-wave"></i> Valeur stock</div>
                        <div class="card-value" id="stat-valeur-stock">0 DA</div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-bar"></i> Chiffre d'affaires</div>
                        <div class="card-value" id="stat-ca">0 DA</div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-coins"></i> B√©n√©fice total</div>
                        <div class="card-value" id="stat-benefice">0 DA</div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-exclamation-triangle"></i> Produits expir√©s</div>
                        <div class="card-value" id="stat-expired">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-star"></i> Top 5 rentables</div>
                        <ul id="top5" class="top-list" style="font-size: 1.2rem; padding-left: 25px;"></ul>
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-circle"></i> <strong>Alertes importantes :</strong>
                    <div id="alertes-stock" style="margin-top: 15px;"></div>
                </div>
            </section>

            <!-- STOCK -->
            <section id="stock" class="section">
                <h1><i class="fas fa-boxes"></i> Gestion des Produits</h1>
                
                <div class="form-row">
                    <button class="btn btn-primary" id="ajouter-produit"><i class="fas fa-plus-circle"></i> Ajouter produit</button>
                    <button class="btn btn-secondary" id="gerer-categories"><i class="fas fa-tag"></i> G√©rer cat√©gories</button>
                    <button class="btn btn-warning" id="importer-produits"><i class="fas fa-file-import"></i> Importer</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex:2">
                        <input type="text" id="recherche-produit" class="form-control" placeholder="üîç Rechercher par nom ou code-barres">
                    </div>
                    <div class="form-group" style="flex:1">
                        <select id="filtre-categorie" class="form-control">
                            <option value="">Toutes cat√©gories</option>
                        </select>
                    </div>
                </div>
                
                <div id="table-produits" class="table-container"></div>
            </section>

            <!-- SCANNER -->
            <section id="scanner" class="section">
                <h1><i class="fas fa-camera"></i> Scanner Code-barres</h1>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Placez le code-barres dans le cadre pour le scanner. Fonctionne avec EAN13, EAN8, Code128 et QR Code.
                </div>
                
                <button class="btn btn-primary" id="open-scanner-modal"><i class="fas fa-camera"></i> D√©marrer le scanner</button>
                
                <div id="scan-result" class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Aucun code scann√© pour le moment
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-info-circle"></i> Information du produit</h2>
                    <div id="product-info"></div>
                </div>
            </section>

            <!-- VENTES -->
            <section id="ventes" class="section">
                <h1><i class="fas fa-shopping-cart"></i> Point de Vente</h1>
                
                <div class="form-row">
                    <button class="btn btn-primary" id="open-vente-scanner"><i class="fas fa-camera"></i> Scanner produit</button>
                    <button class="btn btn-secondary" id="ajouter-manuel"><i class="fas fa-hand-pointer"></i> Ajouter manuellement</button>
                    <button class="btn btn-danger" id="vider-panier"><i class="fas fa-trash"></i> Vider le panier</button>
                </div>
                
                <div id="vente-ligne-container"></div>
                
                <div class="vente-total">
                    <div>Total: <span id="total-vente">0</span> DA</div>
                    <div>B√©n√©fice: <span id="benefice-vente">0</span> DA</div>
                </div>
                
                <div class="form-row" style="justify-content: flex-end">
                    <button class="btn btn-success" id="finaliser-vente" style="font-size:1.4rem; padding:18px 35px">
                        <i class="fas fa-check-circle"></i> Finaliser la vente
                    </button>
                </div>
            </section>

            <!-- HISTORIQUE -->
            <section id="historique" class="section">
                <h1><i class="fas fa-history"></i> Historique des Ventes</h1>
                
                <div class="form-row">
                    <div class="form-group" style="flex:2">
                        <input type="text" id="rech-historique" class="form-control" placeholder="üîç Rechercher par produit">
                    </div>
                    <div class="form-group" style="flex:1">
                        <input type="date" id="date-debut" class="form-control">
                    </div>
                    <div class="form-group" style="flex:1">
                        <input type="date" id="date-fin" class="form-control">
                    </div>
                    <div class="form-group" style="flex:1">
                        <button class="btn btn-primary" id="appliquer-filtros" style="width:100%">
                            <i class="fas fa-filter"></i> Appliquer
                        </button>
                    </div>
                </div>
                
                <div id="table-historique" class="table-container"></div>
            </section>

            <!-- FOURNISSEURS -->
            <section id="fournisseurs" class="section">
                <h1><i class="fas fa-truck"></i> Gestion des Fournisseurs</h1>
                
                <button class="btn btn-primary" id="ajouter-fournisseur"><i class="fas fa-plus-circle"></i> Ajouter fournisseur</button>
                
                <div id="table-fournisseurs" class="table-container" style="margin-top:25px"></div>
            </section>
        </main>
        
        <footer>
            <div>cr√©√© par Ghilas Yahoui &lt;GHS PROD 15&gt; | 
                <a href="https://www.instagram.com/ghilas.yah?igsh=djhoNnl2Ymp6ZXh3&utm_source=qr" target="_blank">
                    <i class="fab fa-instagram"></i> Instagram
                </a> | 
                <a href="https://wa.me/0676330935" target="_blank">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
            </div>
        </footer>

        <!-- MODAL G√âN√âRIQUE -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <button id="close-modal" class="close-modal"><i class="fas fa-times"></i></button>
                <div id="modal-body"></div>
            </div>
        </div>
        
        <!-- MODAL SCANNER -->
        <div id="scanner-modal" class="modal">
            <div class="modal-content">
                <button id="close-scanner-modal" class="close-modal"><i class="fas fa-times"></i></button>
                <h2><i class="fas fa-camera"></i> Scanner Code-barres</h2>
				<center><div id="hola" style="background-color:red;width:300px;height:200px"></div></center>
                <div id="modal-scan-result" class="alert alert-info">
                    <i class="fas fa-info-circle"></i> En attente de scan...
                </div>
                <div class="form-row" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-warning" id="switch-camera" style="font-size:1.1rem; padding:10px 20px">
                        <i class="fas fa-sync"></i> Changer de cam√©ra
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MODAL VENTE SCANNER -->
        <div id="vente-scanner-modal" class="modal">
            <div class="modal-content">
                <button id="close-vente-scanner-modal" class="close-modal"><i class="fas fa-times"></i></button>
                <h2><i class="fas fa-camera"></i> Scanner pour Vente</h2>
                <div class="scanner-container">
                    <div class="scanner-overlay" id="vente-scanner-overlay">
                        <div>
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Chargement de la cam√©ra...</p>
                            <p id="vente-camera-error" class="hidden" style="color: #ff6b6b; margin-top: 10px;"></p>
                        </div>
                    </div>
                    <video id="vente-video" autoplay playsinline muted></video>
                    <div class="scanner-frame">
                        <div class="scanner-animation"></div>
                    </div>
                    <div class="zoom-controls">
                        <button class="zoom-btn" id="vente-zoom-out">-</button>
                        <button class="zoom-btn" id="vente-zoom-in">+</button>
                    </div>
                </div>
                <div id="modal-vente-result" class="alert alert-info">
                    <i class="fas fa-info-circle"></i> En attente de scan...
                </div>
                <div class="form-row" style="justify-content: center; margin-top: 20px;">
                    <button class="btn btn-warning" id="vente-switch-camera" style="font-size:1.1rem; padding:10px 20px">
                        <i class="fas fa-sync"></i> Changer de cam√©ra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function validateLicenseKey(key) {
            const regex = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
            
            if (!regex.test(key)) {
                return false;
            }
            
            const cleanKey = key.replace(/-/g, '').toUpperCase();
            const expectedKey = "1103200306763309";
            
            return cleanKey === expectedKey;
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const licenseKeyInput = document.getElementById('license-key');
            const activateBtn = document.getElementById('activate-btn');
            const licenseError = document.getElementById('license-error');
            const licenseSuccess = document.getElementById('license-success');
            
            licenseKeyInput.addEventListener('input', function() {
                let value = this.value.replace(/-/g, '').toUpperCase();
                if (value.length > 16) value = value.substring(0, 16);
                
                let formatted = '';
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) formatted += '-';
                    formatted += value[i];
                }
                
                this.value = formatted;
            });
            
            activateBtn.addEventListener('click', () => {
                const key = licenseKeyInput.value.trim();
                
                if (!key) {
                    licenseError.textContent = "Veuillez entrer une cl√© de licence";
                    licenseError.style.display = 'block';
                    licenseSuccess.style.display = 'none';
                    return;
                }
                
                if (validateLicenseKey(key)) {
                    localStorage.setItem('app_license', key);
                    
                    licenseError.style.display = 'none';
                    licenseSuccess.style.display = 'block';
                    
                    setTimeout(() => {
                        document.getElementById('license-screen').style.display = 'none';
                        document.getElementById('app-container').style.display = 'block';
                        initApp();
                    }, 2000);
                } else {
                    licenseError.textContent = "Cl√© de licence invalide. Veuillez v√©rifier et r√©essayer.";
                    licenseError.style.display = 'block';
                    licenseSuccess.style.display = 'none';
                }
            });
            
            const savedLicense = localStorage.getItem('app_license');
            if (savedLicense && validateLicenseKey(savedLicense)) {
                document.getElementById('license-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                initApp();
            } else {
                if (savedLicense) localStorage.removeItem('app_license');
            }
        });
        
        let categories = [];
        let fournisseurs = [];
        let produits = [];
        let ventes = [];
        let panierVente = [];
        let codeReader = null;
        let currentStream = null;
        let currentModal = null;
        let currentCameraId = null;
        let cameras = [];
        let currentCameraIndex = 0;
        
        function initApp() {
            initData();
            initEventListeners();
            updateStats();
            updateCategorieFilter();
            setCurrentDate();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-debut').value = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
            document.getElementById('date-fin').value = today;
        }
        
        function setCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', options);
        }
        
        function initData() {
            if(!localStorage.getItem('categories')) {
                localStorage.setItem('categories', JSON.stringify([
                    {id: '1', nom: 'Boissons'},
                    {id: '2', nom: 'Snacks'},
                    {id: '3', nom: 'Produits laitiers'},
                    {id: '4', nom: 'Hygi√®ne'}
                ]));
            }
            
            if(!localStorage.getItem('fournisseurs')) {
                localStorage.setItem('fournisseurs', JSON.stringify([
                    {id: '1', nom: 'Fournisseur 1', whatsapp: '123456789', instagram: 'https://instagram.com/fourn1', adresse: '123 Rue Principale'},
                    {id: '2', nom: 'Fournisseur 2', whatsapp: '987654321', instagram: 'https://instagram.com/fourn2', adresse: '456 Avenue Centrale'}
                ]));
            }
            
            if(!localStorage.getItem('produits')) {
                localStorage.setItem('produits', JSON.stringify([
                    {
                        id: '1', nom: 'Eau min√©rale 1.5L', code: '1234567890123', 
                        categorieId: '1', fournisseurId: '1', 
                        prixAchatUnitaire: 20, prixVenduUnitaire: 30, 
                        prixVenduPack: 150, unitesParPack: 6,
                        stockUnitaires: 50, stockPacks: 10,
                        dateExpiration: '2024-12-31', uniteMesure: 'pi√®ce',
                        dateAjout: '2023-01-15'
                    },
                    {
                        id: '2', nom: 'Chips go√ªt poulet', code: '2345678901234', 
                        categorieId: '2', fournisseurId: '2', 
                        prixAchatUnitaire: 15, prixVenduUnitaire: 25, 
                        prixVenduPack: 120, unitesParPack: 6,
                        stockUnitaires: 100, stockPacks: 15,
                        dateExpiration: '2024-10-15', uniteMesure: 'pi√®ce',
                        dateAjout: '2023-02-20'
                    }
                ]));
            }
            
            if(!localStorage.getItem('ventes')) {
                localStorage.setItem('ventes', JSON.stringify([]));
            }
            
            categories = JSON.parse(localStorage.getItem('categories') || '[]');
            fournisseurs = JSON.parse(localStorage.getItem('fournisseurs') || '[]');
            produits = JSON.parse(localStorage.getItem('produits') || '[]');
            ventes = JSON.parse(localStorage.getItem('ventes') || '[]');
            
            panierVente = [];
        }
        
        function saveData() {
            localStorage.setItem('categories', JSON.stringify(categories));
            localStorage.setItem('fournisseurs', JSON.stringify(fournisseurs));
            localStorage.setItem('produits', JSON.stringify(produits));
            localStorage.setItem('ventes', JSON.stringify(ventes));
        }
        
        function initEventListeners() {
            document.getElementById('nav-toggle').addEventListener('click', toggleNav);
            
            const navBtns = document.querySelectorAll('#main-nav button');
            navBtns.forEach(b => {
                b.addEventListener('click', (e) => {
                    navBtns.forEach(x => x.classList.remove('active'));
                    b.classList.add('active');
                    
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    const sec = document.getElementById(b.id.replace('nav-', ''));
                    if(sec) sec.classList.add('active');
                    
                    switch(b.id) {
                        case 'nav-accueil':
                            updateStats();
                            break;
                        case 'nav-stock':
                            renderProduits();
                            break;
                        case 'nav-fournisseurs':
                            renderFournisseurs();
                            break;
                        case 'nav-historique':
                            renderHistorique();
                            break;
                        case 'nav-scanner':
                            document.getElementById('product-info').innerHTML = '';
                            document.getElementById('scan-result').innerHTML = '<i class="fas fa-info-circle"></i> Aucun code scann√© pour le moment';
                            break;
                    }
                    
                    if(window.innerWidth <= 1024) {
                        document.getElementById('main-nav').classList.remove('nav-expanded');
                        document.getElementById('main-nav').classList.add('nav-collapsed');
                    }
                });
            });
            
            document.getElementById('close-modal').addEventListener('click', () => closeModal());
            document.getElementById('close-scanner-modal').addEventListener('click', () => closeScannerModal());
            document.getElementById('close-vente-scanner-modal').addEventListener('click', () => closeVenteScannerModal());
            
            document.getElementById('ajouter-produit').addEventListener('click', () => openProduitModal(-1));
            document.getElementById('gerer-categories').addEventListener('click', openCategoriesModal);
            document.getElementById('importer-produits').addEventListener('click', () => {
                alert('Fonctionnalit√© d\'importation √† venir dans la prochaine mise √† jour!');
            });
            
            document.getElementById('open-scanner-modal').addEventListener('click', openScannerModal);
            document.getElementById('switch-camera').addEventListener('click', switchCamera);
            document.getElementById('vente-switch-camera').addEventListener('click', switchVenteCamera);
            
            document.getElementById('open-vente-scanner').addEventListener('click', openVenteScannerModal);
            document.getElementById('ajouter-manuel').addEventListener('click', openAjoutManuelModal);
            document.getElementById('finaliser-vente').addEventListener('click', finaliserVente);
            document.getElementById('vider-panier').addEventListener('click', viderPanier);
            
            document.getElementById('ajouter-fournisseur').addEventListener('click', () => openFournModal(-1));
            
            document.getElementById('appliquer-filtros').addEventListener('click', renderHistorique);
            
                   }
        
        function toggleNav() {
            const nav = document.getElementById('main-nav');
            if (nav.classList.contains('nav-collapsed')) {
                nav.classList.remove('nav-collapsed');
                nav.classList.add('nav-expanded');
            } else {
                nav.classList.remove('nav-expanded');
                nav.classList.add('nav-collapsed');
            }
        }
        
        let currentZoom = 1;
        let venteZoom = 1;
        
        function adjustZoom(delta) {
            currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
            document.getElementById('video-preview').style.transform = `scale(${currentZoom})`;
        }
        
        function adjustVenteZoom(delta) {
            venteZoom = Math.max(0.5, Math.min(2, venteZoom + delta));
            document.getElementById('vente-video').style.transform = `scale(${venteZoom})`;
        }
        
        function updateStats() {
            document.getElementById('stat-produits').textContent = produits.length;
            
            let valeurStock = 0;
            produits.forEach(p => {
                valeurStock += (p.prixAchatUnitaire || 0) * (p.stockUnitaires || 0);
                valeurStock += (p.prixAchatUnitaire || 0) * (p.unitesParPack || 1) * (p.stockPacks || 0);
            });
            document.getElementById('stat-valeur-stock').textContent = valeurStock.toLocaleString('fr-DZ') + ' DA';
            
            let caTotal = ventes.reduce((total, vente) => total + vente.total, 0);
            document.getElementById('stat-ca').textContent = caTotal.toLocaleString('fr-DZ') + ' DA';
            
            let beneficeTotal = ventes.reduce((total, vente) => total + vente.benefice, 0);
            document.getElementById('stat-benefice').textContent = beneficeTotal.toLocaleString('fr-DZ') + ' DA';
            
            const today = new Date().toISOString().split('T')[0];
            const expiredCount = produits.filter(p => p.dateExpiration && p.dateExpiration < today).length;
            document.getElementById('stat-expired').textContent = expiredCount;
            
            const topList = document.getElementById('top5');
            topList.innerHTML = '';
            
            const productsWithProfit = produits.map(p => {
                const ventesProduit = ventes.flatMap(v => v.lignes.filter(l => l.code === p.code));
                const profit = ventesProduit.reduce((total, ligne) => {
                    return total + (ligne.prixVendu - ligne.prixAchat) * ligne.quantite;
                }, 0);
                return { ...p, profit };
            });
            
            productsWithProfit.sort((a, b) => b.profit - a.profit);
            
            const top5 = productsWithProfit.slice(0, 5);
            if (top5.length === 0) {
                topList.innerHTML = '<li>Aucun produit vendu pour le moment</li>';
            } else {
                top5.forEach(p => {
                    if(p.profit > 0) {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${p.nom}</strong>: ${p.profit.toLocaleString('fr-DZ')} DA`;
                        li.style.marginBottom = '10px';
                        topList.appendChild(li);
                    }
                });
            }
            
            updateStockAlerts();
        }
        
        function updateStockAlerts() {
            const alertesContainer = document.getElementById('alertes-stock');
            alertesContainer.innerHTML = '';
            
            const outOfStock = produits.filter(p => 
                (p.stockUnitaires <= 0 || p.stockUnitaires < 5) && 
                (p.stockPacks <= 0 || p.stockPacks < 2)
            );
            
            const today = new Date().toISOString().split('T')[0];
            const expiredProducts = produits.filter(p => p.dateExpiration && p.dateExpiration < today);
            
            if(outOfStock.length > 0) {
                const div = document.createElement('div');
                div.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Rupture de stock:</strong> ${outOfStock.length} produit(s)`;
                div.style.marginTop = '15px';
                div.style.fontSize = '1.2rem';
                alertesContainer.appendChild(div);
                
                outOfStock.forEach(p => {
                    const prodDiv = document.createElement('div');
                    prodDiv.innerHTML = `- ${p.nom} (Stock: ${p.stockUnitaires} unit√©s, ${p.stockPacks} packs)`;
                    prodDiv.style.marginLeft = '25px';
                    prodDiv.style.fontSize = '1.1rem';
                    alertesContainer.appendChild(prodDiv);
                });
            }
            
            if(expiredProducts.length > 0) {
                const div = document.createElement('div');
                div.innerHTML = `<i class="fas fa-calendar-times"></i> <strong>Produits expir√©s:</strong> ${expiredProducts.length} produit(s)`;
                div.style.marginTop = '15px';
                div.style.fontSize = '1.2rem';
                alertesContainer.appendChild(div);
                
                expiredProducts.forEach(p => {
                    const prodDiv = document.createElement('div');
                    prodDiv.innerHTML = `- ${p.nom} (Exp: ${p.dateExpiration})`;
                    prodDiv.style.marginLeft = '25px';
                    prodDiv.style.fontSize = '1.1rem';
                    alertesContainer.appendChild(prodDiv);
                });
            }
            
            if(outOfStock.length === 0 && expiredProducts.length === 0) {
                alertesContainer.innerHTML = '<div style="font-size:1.2rem"><i class="fas fa-check-circle"></i> Aucune alerte pour le moment</div>';
            }
        }
        
        function renderProduits() {
            const container = document.getElementById('table-produits');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Code</th>
                            <th>Cat√©gorie</th>
                            <th>Fournisseur</th>
                            <th>PA U</th>
                            <th>PV U</th>
                            <th>PV P</th>
                            <th>Unit√©s/Pack</th>
                            <th>Stock U</th>
                            <th>Stock P</th>
                            <th>Date Exp</th>
                            <th>Date Ajout</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            produits.forEach((p, i) => {
                const categorie = categories.find(c => c.id === p.categorieId)?.nom || 'Non cat√©goris√©';
                const fournisseur = fournisseurs.find(f => f.id === p.fournisseurId)?.nom || 'Non d√©fini';
                
                const stockUClass = p.stockUnitaires <= 5 ? 'style="color:red; font-weight:bold"' : '';
                const stockPClass = p.stockPacks <= 2 ? 'style="color:red; font-weight:bold"' : '';
                
                const today = new Date();
                const expDate = p.dateExpiration ? new Date(p.dateExpiration) : null;
                const isExpired = expDate && expDate < today;
                const expClass = isExpired ? 'style="color:red; font-weight:bold"' : '';
                
                html += `
                    <tr>
                        <td>${p.nom}</td>
                        <td>${p.code}</td>
                        <td>${categorie}</td>
                        <td>${fournisseur}</td>
                        <td>${p.prixAchatUnitaire} DA</td>
                        <td>${p.prixVenduUnitaire} DA</td>
                        <td>${p.prixVenduPack} DA</td>
                        <td>${p.unitesParPack}</td>
                        <td ${stockUClass}>${p.stockUnitaires}</td>
                        <td ${stockPClass}>${p.stockPacks}</td>
                        <td ${expClass}>${p.dateExpiration || '-'}</td>
                        <td>${p.dateAjout || '-'}</td>
                        <td class="table-actions">
                            <button data-id="${p.id}" class="edit-produit btn btn-secondary"><i class="fas fa-edit"></i></button>
                            <button data-id="${p.id}" class="del-produit btn btn-danger"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-produit').forEach(b => {
                b.addEventListener('click', e => {
                    const id = e.target.closest('button').dataset.id;
                    const index = produits.findIndex(p => p.id === id);
                    openProduitModal(index);
                });
            });
            
            document.querySelectorAll('.del-produit').forEach(b => {
                b.addEventListener('click', e => {
                    const id = e.target.closest('button').dataset.id;
                    if(confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
                        produits = produits.filter(p => p.id !== id);
                        saveData();
                        renderProduits();
                        updateStats();
                    }
                });
            });
            
            document.getElementById('recherche-produit').addEventListener('input', filterProduits);
            document.getElementById('filtre-categorie').addEventListener('change', filterProduits);
        }
        
        function filterProduits() {
            const term = document.getElementById('recherche-produit').value.toLowerCase();
            const catVal = document.getElementById('filtre-categorie').value;
            
            document.querySelectorAll('#table-produits tbody tr').forEach(tr => {
                const nom = tr.cells[0].textContent.toLowerCase();
                const code = tr.cells[1].textContent;
                const cat = tr.cells[2].textContent;
                
                const show = (nom.includes(term) || code.includes(term)) && 
                             (!catVal || catVal === '' || catVal === categories.find(c => c.id === catVal)?.nom);
                
                tr.style.display = show ? '' : 'none';
            });
        }
        
        function updateCategorieFilter() {
            const select = document.getElementById('filtre-categorie');
            select.innerHTML = '<option value="">Toutes cat√©gories</option>';
            
            categories.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.nom;
                select.appendChild(option);
            });
        }
        
        function openProduitModal(index) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <h2><i class="fas ${index >= 0 ? 'fa-edit' : 'fa-plus-circle'}"></i> ${index >= 0 ? 'Modifier' : 'Ajouter'} Produit</h2>
                
                <div class="form-group">
                    <label class="form-label">Nom du produit</label>
                    <input type="text" id="p-nom" class="form-control" placeholder="Nom du produit" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Code-barres</label>
                        <div style="display:flex;gap:10px">
                            <input type="text" id="p-code" class="form-control" placeholder="Code-barres" required>
                            <button class="btn btn-secondary" id="scanner-produit"><i class="fas fa-camera"></i></button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Unit√© de mesure</label>
                        <select id="p-unite" class="form-control">
                            <option value="pi√®ce">Pi√®ce</option>
                            <option value="kg">Kilogramme</option>
                            <option value="gramme">Gramme</option>
                            <option value="litre">Litre</option>
                            <option value="m√®tre">M√®tre</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cat√©gorie</label>
                        <select id="p-categorie" class="form-control">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fournisseur</label>
                        <select id="p-fournisseur" class="form-control">
                            <option value="">-- S√©lectionner --</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prix d'achat unitaire (DA)</label>
                        <input type="number" id="p-prixA" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prix de vente unitaire (DA)</label>
                        <input type="number" id="p-prixVU" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prix de vente pack (DA)</label>
                        <input type="number" id="p-prixVP" class="form-control auto-calc" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Unit√©s par pack</label>
                        <input type="number" id="p-unitPerPack" class="form-control" placeholder="1" min="1" value="1" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stock unit√©s</label>
                        <input type="number" id="p-stockU" class="form-control" placeholder="0" min="0" value="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Stock packs</label>
                        <input type="number" id="p-stockP" class="form-control" placeholder="0" min="0" value="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date d'expiration</label>
                        <input type="date" id="p-dateE" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date d'ajout</label>
                        <input type="date" id="p-dateAjout" class="form-control" readonly>
                    </div>
                </div>
                
                <div class="form-row" style="justify-content:flex-end; margin-top:25px">
                    <button class="btn btn-secondary" id="cancel-produit">Annuler</button>
                    <button class="btn btn-primary" id="save-produit">Enregistrer</button>
                </div>
            `;
            
            const catSelect = document.getElementById('p-categorie');
            categories.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.nom;
                catSelect.appendChild(option);
            });
            
            const fourSelect = document.getElementById('p-fournisseur');
            fournisseurs.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.nom;
                fourSelect.appendChild(option);
            });
            
            if(index >= 0) {
                const p = produits[index];
                document.getElementById('p-nom').value = p.nom || '';
                document.getElementById('p-code').value = p.code || '';
                document.getElementById('p-unite').value = p.uniteMesure || 'pi√®ce';
                document.getElementById('p-categorie').value = p.categorieId || '';
                document.getElementById('p-fournisseur').value = p.fournisseurId || '';
                document.getElementById('p-prixA').value = p.prixAchatUnitaire || 0;
                document.getElementById('p-prixVU').value = p.prixVenduUnitaire || 0;
                document.getElementById('p-prixVP').value = p.prixVenduPack || 0;
                document.getElementById('p-unitPerPack').value = p.unitesParPack || 1;
                document.getElementById('p-stockU').value = p.stockUnitaires || 0;
                document.getElementById('p-stockP').value = p.stockPacks || 0;
                document.getElementById('p-dateE').value = p.dateExpiration || '';
                document.getElementById('p-dateAjout').value = p.dateAjout || '';
            } else {
                document.getElementById('p-dateAjout').value = new Date().toISOString().split('T')[0];
            }
            
            const prixVUInput = document.getElementById('p-prixVU');
            const unitPerPackInput = document.getElementById('p-unitPerPack');
            const prixVPInput = document.getElementById('p-prixVP');
            
            function calculatePackPrice() {
                const prixVU = parseFloat(prixVUInput.value) || 0;
                const unitPerPack = parseInt(unitPerPackInput.value) || 1;
                prixVPInput.value = (prixVU * unitPerPack).toFixed(2);
            }
            
            prixVUInput.addEventListener('input', calculatePackPrice);
            unitPerPackInput.addEventListener('input', calculatePackPrice);
            
            document.getElementById('scanner-produit').addEventListener('click', () => {
                openScannerModalForProduct();
            });
            
            document.getElementById('save-produit').addEventListener('click', () => {
                const nom = document.getElementById('p-nom').value.trim();
                const code = document.getElementById('p-code').value.trim();
                
                if(!nom) {
                    alert('Le nom est obligatoire');
                    return;
                }
                
                if(!code) {
                    alert('Le code-barres est obligatoire');
                    return;
                }
                
                const produit = {
                    nom,
                    code,
                    uniteMesure: document.getElementById('p-unite').value,
                    categorieId: document.getElementById('p-categorie').value || null,
                    fournisseurId: document.getElementById('p-fournisseur').value || null,
                    prixAchatUnitaire: parseFloat(document.getElementById('p-prixA').value) || 0,
                    prixVenduUnitaire: parseFloat(document.getElementById('p-prixVU').value) || 0,
                    prixVenduPack: parseFloat(document.getElementById('p-prixVP').value) || 0,
                    unitesParPack: parseInt(document.getElementById('p-unitPerPack').value) || 1,
                    stockUnitaires: parseInt(document.getElementById('p-stockU').value) || 0,
                    stockPacks: parseInt(document.getElementById('p-stockP').value) || 0,
                    dateExpiration: document.getElementById('p-dateE').value || null,
                    dateAjout: document.getElementById('p-dateAjout').value
                };
                
                if(index >= 0) {
                    produit.id = produits[index].id;
                    produits[index] = produit;
                } else {
                    if(produits.some(p => p.code === produit.code)) {
                        alert('Un produit avec ce code-barres existe d√©j√†!');
                        return;
                    }
                    
                    produit.id = Date.now().toString();
                    produits.push(produit);
                }
                
                saveData();
                renderProduits();
                updateStats();
                closeModal();
            });
            
            document.getElementById('cancel-produit').addEventListener('click', closeModal);
            
            openModal();
        }
        
        function openCategoriesModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <h2><i class="fas fa-tags"></i> G√©rer les Cat√©gories</h2>
                
                <div class="form-group" style="display:flex;gap:10px">
                    <input type="text" id="new-categorie" class="form-control" placeholder="Nom de la nouvelle cat√©gorie">
                    <button class="btn btn-primary" id="add-categorie"><i class="fas fa-plus"></i> Ajouter</button>
                </div>
                
                <div id="categories-list" style="margin-top:25px"></div>
            `;
            
            renderCategoriesList();
            
            document.getElementById('add-categorie').addEventListener('click', () => {
                const nom = document.getElementById('new-categorie').value.trim();
                if(nom) {
                    if(categories.some(c => c.nom.toLowerCase() === nom.toLowerCase())) {
                        alert('Cette cat√©gorie existe d√©j√†!');
                        return;
                    }
                    
                    categories.push({
                        id: Date.now().toString(),
                        nom
                    });
                    saveData();
                    renderCategoriesList();
                    document.getElementById('new-categorie').value = '';
                    updateCategorieFilter();
                } else {
                    alert('Veuillez entrer un nom de cat√©gorie');
                }
            });
            
            openModal();
        }
        
        function renderCategoriesList() {
            const container = document.getElementById('categories-list');
            container.innerHTML = '';
            
            if(categories.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Aucune cat√©gorie disponible</div>';
                return;
            }
            
            categories.forEach((cat, index) => {
                const div = document.createElement('div');
                div.className = 'form-row';
                div.style.alignItems = 'center';
                div.style.marginBottom = '15px';
                div.style.padding = '15px';
                div.style.borderBottom = '1px solid #eee';
                div.style.fontSize = '1.2rem';
                
                div.innerHTML = `
                    <div style="flex:1">${cat.nom}</div>
                    <div>
                        <button class="btn btn-secondary edit-cat" data-index="${index}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger delete-cat" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            document.querySelectorAll('.edit-cat').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.index;
                    const newName = prompt('Modifier le nom de la cat√©gorie:', categories[index].nom);
                    if(newName && newName.trim()) {
                        categories[index].nom = newName.trim();
                        saveData();
                        renderCategoriesList();
                        updateCategorieFilter();
                        renderProduits();
                    }
                });
            });
            
            document.querySelectorAll('.delete-cat').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.index;
                    const catName = categories[index].nom;
                    
                    const productsUsingCategory = produits.filter(p => p.categorieId === categories[index].id);
                    if(productsUsingCategory.length > 0) {
                        alert(`Impossible de supprimer cette cat√©gorie car ${productsUsingCategory.length} produit(s) l'utilisent.`);
                        return;
                    }
                    
                    if(confirm(`Supprimer la cat√©gorie "${catName}" ?`)) {
                        categories.splice(index, 1);
                        saveData();
                        renderCategoriesList();
                        updateCategorieFilter();
                    }
                });
            });
        }
        
        function renderFournisseurs() {
            const container = document.getElementById('table-fournisseurs');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Contact</th>
                            <th>Adresse</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            fournisseurs.forEach((f, i) => {
                html += `
                    <tr>
                        <td>${f.nom}</td>
                        <td>
                            ${f.whatsapp ? `<div><a href="https://wa.me/${f.whatsapp}" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></div>` : ''}
                            ${f.instagram ? `<div><a href="${f.instagram}" target="_blank"><i class="fab fa-instagram"></i> Instagram</a></div>` : ''}
                        </td>
                        <td>${f.adresse || '-'}</td>
                        <td class="table-actions">
                            <button data-index="${i}" class="edit-f btn btn-secondary"><i class="fas fa-edit"></i></button>
                            <button data-index="${i}" class="del-f btn btn-danger"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
            
            document.querySelectorAll('.edit-f').forEach(b => {
                b.addEventListener('click', e => {
                    const index = e.target.closest('button').dataset.index;
                    openFournModal(index);
                });
            });
            
            document.querySelectorAll('.del-f').forEach(b => {
                b.addEventListener('click', e => {
                    const index = e.target.closest('button').dataset.index;
                    const fournisseur = fournisseurs[index];
                    
                    const productsUsingFournisseur = produits.filter(p => p.fournisseurId === fournisseur.id);
                    if(productsUsingFournisseur.length > 0) {
                        alert(`Impossible de supprimer ce fournisseur car ${productsUsingFournisseur.length} produit(s) l'utilisent.`);
                        return;
                    }
                    
                    if(confirm(`Supprimer le fournisseur "${fournisseur.nom}" ?`)) {
                        fournisseurs.splice(index, 1);
                        saveData();
                        renderFournisseurs();
                    }
                });
            });
        }
        
        function openFournModal(index) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <h2><i class="fas ${index >= 0 ? 'fa-edit' : 'fa-plus-circle'}"></i> ${index >= 0 ? 'Modifier' : 'Ajouter'} Fournisseur</h2>
                
                <div class="form-group">
                    <label class="form-label">Nom du fournisseur</label>
                    <input type="text" id="f-nom" class="form-control" placeholder="Nom" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">WhatsApp</label>
                    <input type="text" id="f-whatsapp" class="form-control" placeholder="Num√©ro sans +">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Instagram</label>
                    <input type="text" id="f-instagram" class="form-control" placeholder="URL Instagram">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <textarea id="f-adresse" class="form-control" placeholder="Adresse compl√®te" rows="3"></textarea>
                </div>
                
                <div class="form-row" style="justify-content:flex-end; margin-top:25px">
                    <button class="btn btn-secondary" id="cancel-fournisseur">Annuler</button>
                    <button class="btn btn-primary" id="save-fournisseur">Enregistrer</button>
                </div>
            `;
            
            if(index >= 0) {
                const f = fournisseurs[index];
                document.getElementById('f-nom').value = f.nom || '';
                document.getElementById('f-whatsapp').value = f.whatsapp || '';
                document.getElementById('f-instagram').value = f.instagram || '';
                document.getElementById('f-adresse').value = f.adresse || '';
            }
            
            document.getElementById('save-fournisseur').addEventListener('click', () => {
                const nom = document.getElementById('f-nom').value.trim();
                if(!nom) {
                    alert('Le nom est obligatoire');
                    return;
                }
                
                const fournisseur = {
                    nom,
                    whatsapp: document.getElementById('f-whatsapp').value.trim(),
                    instagram: document.getElementById('f-instagram').value.trim(),
                    adresse: document.getElementById('f-adresse').value.trim()
                };
                
                if(index >= 0) {
                    fournisseur.id = fournisseurs[index].id;
                    fournisseurs[index] = fournisseur;
                } else {
                    if(fournisseurs.some(f => f.nom.toLowerCase() === nom.toLowerCase())) {
                        alert('Un fournisseur avec ce nom existe d√©j√†!');
                        return;
                    }
                    
                    fournisseur.id = Date.now().toString();
                    fournisseurs.push(fournisseur);
                }
                
                saveData();
                renderFournisseurs();
                closeModal();
            });
            
            document.getElementById('cancel-fournisseur').addEventListener('click', closeModal);
            
            openModal();
        }
        
        function stopScanner() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        function restartScanner() {
            stopScanner();
            openScannerModal();
        }
        
        function restartVenteScanner() {
            stopScanner();
            openVenteScannerModal();
        }
        
        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                return devices.filter(device => device.kind === 'videoinput');
            } catch (err) {
                console.error('Erreur lors de la r√©cup√©ration des cam√©ras:', err);
                return [];
            }
        }
        
        function switchCamera() {
            if (cameras.length < 2) return;
            
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            const newCameraId = cameras[currentCameraIndex].deviceId;
            
            stopScanner();
            openScannerModal(newCameraId);
        }
        
        function switchVenteCamera() {
			alert(cameras.length);
			console.log(cameras)
			alert(currentCameraIndex)
            if (cameras.length < 2) return;
            
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
			alert(currentCameraIndex)
            const newCameraId = cameras[currentCameraIndex].deviceId;
            
            stopScanner();
            openVenteScannerModal(newCameraId);
        }
        
        async function openScannerModal() {
            openModal('scanner-modal');
            currentModal = 'scanner-modal';
            
            const videoElem = document.getElementById('video-preview');
            const resultDiv = document.getElementById('modal-scan-result');
            //const overlay = document.getElementById('scanner-overlay');
            //const errorMsg = document.getElementById('camera-error');
            
            resultDiv.innerHTML = '<i class="fas fa-info-circle"></i> En attente de scan...';
            // overlay.classList.remove('hidden');
           // errorMsg.classList.add('hidden');
            
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.getElementById('hola'),
          constraints: {
            facingMode: "environment", // cam√©ra arri√®re
			 width: { ideal: 200 },   // ou exact: 640
             height: { ideal: 300 }
			
          }
        },
        decoder: {
          readers: ["ean_reader"] // pour codes EAN-13
        }
      }, function(err) {
        if (err) {
          console.error('Erreur de scan:', err);
                            resultDiv.innerHTML = `<div style="color:red;font-size:1.2rem">
                                <i class="fas fa-exclamation-triangle"></i> Erreur de scan: ${err || 'Probl√®me avec le scanner'}
                                <button id="retry-scanner" class="btn btn-primary" style="margin-top:10px">R√©essayer</button>
                            </div>`;
                            document.getElementById('retry-scanner').addEventListener('click', restartScanner);
          return;
        }
        Quagga.start();
		//overlay.classList.add('hidden');
        //document.getElementById('status').innerText = "Scanner en cours...";
      });
	  
	    Quagga.onDetected(async function(result) {
        const code = result.codeResult.code;
        resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> Code d√©tect√©: ${code}`;
		const produit = produits.find(p => p.code === code);
        if (produit) {
            showProductInfo(produit);
        } else {
             resultDiv.innerHTML += `<div style="margin-top:15px;color:red;font-size:1.2rem"><i class="fas fa-exclamation-triangle"></i> Produit non trouv√©</div>`;
        }
                                
        
        if (navigator.vibrate) {
            navigator.vibrate(200);
                                }
        Quagga.stop()
})}
        async function openScannerModalForProduct() {
            openModal('scanner-modal');
            currentModal = 'scanner-modal';
            
            const videoElem = document.getElementById('video-preview');
            const resultDiv = document.getElementById('modal-scan-result');
            const overlay = document.getElementById('scanner-overlay');
            const errorMsg = document.getElementById('camera-error');
            
            resultDiv.innerHTML = '<i class="fas fa-info-circle"></i> Scanner le code-barres du produit...';
            overlay.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            
            currentZoom = 1;
            videoElem.style.transform = 'scale(1)';
            
            // Obtenir la liste des cam√©ras si n√©cessaire
            if (cameras.length === 0) {
                cameras = await getCameras();
            }
            
            // Configuration ZXing avec formats sp√©cifiques
            const hints = new Map();
            const formats = [
                ZXing.BarcodeFormat.EAN_13,
                ZXing.BarcodeFormat.EAN_8,
                ZXing.BarcodeFormat.CODE_128,
                ZXing.BarcodeFormat.CODE_39,
                ZXing.BarcodeFormat.CODE_93,
                ZXing.BarcodeFormat.QR_CODE
            ];
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            
            codeReader = new ZXing.BrowserMultiFormatReader(hints);
            
            // Contraintes avec focus automatique
            const constraints = { 
                video: { 
                    deviceId: cameras[currentCameraIndex]?.deviceId ? { exact: cameras[currentCameraIndex].deviceId } : undefined,
                    facingMode: cameras.length > 0 ? undefined : 'environment',
                    width: { min: 640, ideal: 1280 },
                    height: { min: 480, ideal: 720 },
                    focusMode: 'continuous'
                } 
            };
            
            // R√©initialiser le flux vid√©o existant
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                videoElem.srcObject = stream;
                
                // D√©marrer le scanner une fois que la vid√©o est pr√™te
                videoElem.onplaying = () => {
                    overlay.classList.add('hidden');
                    
                    // D√©lai pour laisser la cam√©ra s'ajuster
                    setTimeout(() => {
                        codeReader.decodeFromVideoElement(videoElem, (result, err) => {
                            if (result) {
                                resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> Code d√©tect√©: ${result.text}`;
                                
                                document.getElementById('p-code').value = result.text;
                                
                                // Vibrer si possible
                                if (navigator.vibrate) {
                                    navigator.vibrate(100);
                                }
                                
                                // Fermer le modal apr√®s un court d√©lai
                                setTimeout(() => {
                                    closeModal('scanner-modal');
                                    stopScanner();
                                }, 500);
                            }
                        }).catch(err => {
                            console.error('Erreur de scan:', err);
                            resultDiv.innerHTML = `<div style="color:red;font-size:1.2rem">
                                <i class="fas fa-exclamation-triangle"></i> Erreur de scan: ${err.message || 'Probl√®me avec le scanner'}
                                <button id="retry-scanner" class="btn btn-primary" style="margin-top:10px">R√©essayer</button>
                            </div>`;
                            document.getElementById('retry-scanner').addEventListener('click', restartScanner);
                        });
                    }, 1000);
                };
            } catch (err) {
                console.error('Erreur de cam√©ra:', err);
                overlay.classList.remove('hidden');
                errorMsg.classList.remove('hidden');
                
                // Message plus explicite
                let errorText = 'Erreur: ';
                if (err.name === 'NotAllowedError') {
                    errorText += 'Permission cam√©ra refus√©e. Autorisez l\'acc√®s dans les param√®tres du navigateur.';
                } else if (err.name === 'NotFoundError') {
                    errorText += 'Cam√©ra non trouv√©e. V√©rifiez votre appareil.';
                } else if (err.name === 'OverconstrainedError') {
                    errorText += 'Aucune cam√©ra ne correspond aux contraintes demand√©es.';
                } else {
                    errorText += `${err.message || 'Probl√®me technique'}`;
                }
                
                errorMsg.textContent = errorText;
            }
        }
        
        function closeScannerModal() {
            stopScanner();
            closeModal('scanner-modal');
        }
        
        function showProductInfo(produit) {
            const productInfo = document.getElementById('product-info');
            if(!productInfo) return;
            
            const categorie = categories.find(c => c.id === produit.categorieId)?.nom || 'Inconnue';
            const fournisseur = fournisseurs.find(f => f.id === produit.fournisseurId)?.nom || 'Inconnu';
            
            const today = new Date();
            const expDate = produit.dateExpiration ? new Date(produit.dateExpiration) : null;
            const isExpired = expDate && expDate < today;
            
            const valeurStock = (produit.prixAchatUnitaire * produit.stockUnitaires) + 
                              (produit.prixAchatUnitaire * produit.unitesParPack * produit.stockPacks);
            
            productInfo.innerHTML = `
                <div style="display:flex; gap:25px; margin-bottom:20px">
                    <div style="flex:1">
                        <h3 style="font-size:1.5rem">${produit.nom}</strong></h3>
                        <div style="margin-bottom:8px"><strong>Code:</strong> ${produit.code}</div>
                        <div style="margin-bottom:8px"><strong>Cat√©gorie:</strong> ${categorie}</div>
                        <div><strong>Fournisseur:</strong> ${fournisseur}</div>
                    </div>
                    <div style="flex:1">
                        <div style="margin-bottom:8px"><strong>Prix d'achat:</strong> ${produit.prixAchatUnitaire} DA</div>
                        <div style="margin-bottom:8px"><strong>Prix de vente unitaire:</strong> ${produit.prixVenduUnitaire} DA</div>
                        <div style="margin-bottom:8px"><strong>Prix de vente pack:</strong> ${produit.prixVenduPack} DA</div>
                        <div><strong>Unit√©s par pack:</strong> ${produit.unitesParPack}</div>
                    </div>
                </div>
                
                <div style="display:flex; gap:25px; margin-top:20px">
                    <div style="flex:1; background:${produit.stockUnitaires < 10 ? '#fff3cd' : '#d4edda'}; padding:15px; border-radius:10px">
                        <div style="margin-bottom:8px"><strong>Stock unit√©s:</strong> ${produit.stockUnitaires}</div>
                        <div style="margin-bottom:8px"><strong>Stock packs:</strong> ${produit.stockPacks}</div>
                        <div><strong>Valeur du stock:</strong> ${valeurStock.toFixed(2)} DA</div>
                    </div>
                    <div style="flex:1; background:${isExpired ? '#f8d7da' : '#d1ecf1'}; padding:15px; border-radius:10px">
                        <div style="margin-bottom:8px"><strong>Date d'expiration:</strong> ${produit.dateExpiration || 'Non d√©finie'}</div>
                        <div style="margin-bottom:8px"><strong>Date d'ajout:</strong> ${produit.dateAjout || 'Non d√©finie'}</div>
                        ${isExpired ? '<div style="color:red; font-weight:bold; font-size:1.2rem"><i class="fas fa-exclamation-triangle"></i> Produit expir√©</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        async function openVenteScannerModal(cameraId = null) {
            openModal('vente-scanner-modal');
            currentModal = 'vente-scanner-modal';
            
            const videoElem = document.getElementById('vente-video');
            const resultDiv = document.getElementById('modal-vente-result');
            const overlay = document.getElementById('vente-scanner-overlay');
            const errorMsg = document.getElementById('vente-camera-error');
            
            resultDiv.innerHTML = '<i class="fas fa-info-circle"></i> Scanner un produit pour l\'ajouter au panier...';
            overlay.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            
            venteZoom = 1;
            videoElem.style.transform = 'scale(1)';
            
            // Obtenir la liste des cam√©ras si n√©cessaire
            if (cameras.length === 0) {
                cameras = await getCameras();
            }
            
            // Configuration ZXing avec formats sp√©cifiques
            const hints = new Map();
            const formats = [
                ZXing.BarcodeFormat.EAN_13,
                ZXing.BarcodeFormat.EAN_8,
                ZXing.BarcodeFormat.CODE_128,
                ZXing.BarcodeFormat.CODE_39,
                ZXing.BarcodeFormat.CODE_93,
                ZXing.BarcodeFormat.QR_CODE
            ];
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            
            codeReader = new ZXing.BrowserMultiFormatReader(hints);
            
            // Contraintes avec focus automatique
            const constraints = { 
                video: { 
                    deviceId: cameraId ? { exact: cameraId } : undefined,
                    facingMode: cameraId ? undefined : 'environment',
                    width: { min: 640, ideal: 1280 },
                    height: { min: 480, ideal: 720 },
                    focusMode: 'continuous'
                } 
            };
            
            // R√©initialiser le flux vid√©o existant
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                videoElem.srcObject = stream;
                
                // D√©marrer le scanner une fois que la vid√©o est pr√™te
                videoElem.onplaying = () => {
                    overlay.classList.add('hidden');
                    
                    // D√©lai pour laisser la cam√©ra s'ajuster
                    setTimeout(() => {
                        codeReader.decodeFromVideoElement(videoElem, (result, err) => {
                            if (result) {
                                resultDiv.innerHTML = `<i class="fas fa-check-circle"></i> Code d√©tect√©: ${result.text}`;
                                
                                const produit = produits.find(p => p.code === result.text);
                                if (produit) {
                                    addToPanier(produit);
                                    resultDiv.innerHTML += `<div style="margin-top:15px;color:green;font-size:1.2rem"><i class="fas fa-check"></i> ${produit.nom} ajout√© au panier</div>`;
                                    
                                    // Vibrer si possible
                                    if (navigator.vibrate) {
                                        navigator.vibrate(100);
                                    }
                                    
                                    // Fermer le modal apr√®s un court d√©lai
                                    setTimeout(() => {
                                        closeModal('vente-scanner-modal');
                                        stopScanner();
                                    }, 500);
                                } else {
                                    resultDiv.innerHTML += `<div style="margin-top:15px;color:red;font-size:1.2rem"><i class="fas fa-exclamation-triangle"></i> Produit non trouv√©</div>`;
                                }
                            }
                        }).catch(err => {
                            console.error('Erreur de scan:', err);
                            resultDiv.innerHTML = `<div style="color:red;font-size:1.2rem">
                                <i class="fas fa-exclamation-triangle"></i> Erreur de scan: ${err.message || 'Probl√®me avec le scanner'}
                                <button id="retry-vente-scanner" class="btn btn-primary" style="margin-top:10px">R√©essayer</button>
                            </div>`;
                            document.getElementById('retry-vente-scanner').addEventListener('click', restartVenteScanner);
                        });
                    }, 1000);
                };
            } catch (err) {
                console.error('Erreur de cam√©ra:', err);
                overlay.classList.remove('hidden');
                errorMsg.classList.remove('hidden');
                
                // Message plus explicite
                let errorText = 'Erreur: ';
                if (err.name === 'NotAllowedError') {
                    errorText += 'Permission cam√©ra refus√©e. Autorisez l\'acc√®s dans les param√®tres du navigateur.';
                } else if (err.name === 'NotFoundError') {
                    errorText += 'Cam√©ra non trouv√©e. V√©rifiez votre appareil.';
                } else if (err.name === 'OverconstrainedError') {
                    errorText += 'Aucune cam√©ra ne correspond aux contraintes demand√©es.';
                } else {
                    errorText += `${err.message || 'Probl√®me technique'}`;
                }
                
                errorMsg.textContent = errorText;
            }
        }
        
        function closeVenteScannerModal() {
            stopScanner();
            closeModal('vente-scanner-modal');
        }
        
        function openAjoutManuelModal() {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            
            body.innerHTML = `
                <h2><i class="fas fa-hand-pointer"></i> Ajouter un produit manuellement</h2>
                
                <div class="form-group">
                    <label class="form-label">Rechercher un produit</label>
                    <input type="text" id="search-produit" class="form-control" placeholder="Nom ou code-barres">
                </div>
                
                <div id="produits-list" style="max-height:400px; overflow-y:auto; margin-top:20px"></div>
            `;
            
            document.getElementById('search-produit').addEventListener('input', function() {
                const term = this.value.toLowerCase();
                const container = document.getElementById('produits-list');
                container.innerHTML = '';
                
                if(!term) return;
                
                const filtered = produits.filter(p => 
                    p.nom.toLowerCase().includes(term) || 
                    (p.code && p.code.includes(term))
                ).slice(0, 10);
                
                if(filtered.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Aucun produit trouv√©</div>';
                    return;
                }
                
                filtered.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'produit-item';
                    div.style.padding = '15px';
                    div.style.borderBottom = '1px solid #eee';
                    div.style.cursor = 'pointer';
                    div.style.fontSize = '1.2rem';
                    div.style.transition = 'background 0.3s';
                    
                    div.innerHTML = `
                        <div><strong>${p.nom}</strong></div>
                        <div>Code: ${p.code}</div>
                        <div>Prix: ${p.prixVenduUnitaire} DA</div>
                        <div>Stock: ${p.stockUnitaires} unit√©s</div>
                    `;
                    
                    div.addEventListener('mouseenter', () => {
                        div.style.background = '#f1f7ff';
                    });
                    
                    div.addEventListener('mouseleave', () => {
                        div.style.background = '';
                    });
                    
                    div.addEventListener('click', () => {
                        addToPanier(p);
                        closeModal();
                    });
                    
                    container.appendChild(div);
                });
            });
            
            openModal();
        }
        
        function addToPanier(produit) {
            const existing = panierVente.find(item => item.id === produit.id);
            
            if(existing) {
                existing.quantite += 1;
            } else {
                panierVente.push({
                    id: produit.id,
                    code: produit.code,
                    nom: produit.nom,
                    prixAchat: produit.prixAchatUnitaire,
                    prixVendu: produit.prixVenduUnitaire,
                    quantite: 1,
                    type: 'u'
                });
            }
            
            renderPanier();
        }
        
        function renderPanier() {
            const container = document.getElementById('vente-ligne-container');
            container.innerHTML = '';
            
            if(panierVente.length === 0) {
                container.innerHTML = '<div class="alert alert-info" style="font-size:1.2rem"><i class="fas fa-info-circle"></i> Le panier est vide</div>';
                updateVenteTotal();
                return;
            }
            
            panierVente.forEach((item, index) => {
                const produit = produits.find(p => p.id === item.id);
                if(!produit) return;
                
                const ligne = document.createElement('div');
                ligne.className = 'vente-ligne';
                ligne.innerHTML = `
                    <div class="vente-info">
                        <div style="font-size:1.3rem"><strong>${item.nom}</strong></div>
                        <div>Code: ${item.code}</div>
                    </div>
                    
                    <div class="vente-qty">
                        <label style="font-size:1.2rem">Quantit√©:</label>
                        <input type="number" min="1" value="${item.quantite}" class="form-control" style="width:100px; font-size:1.2rem" data-index="${index}">
                    </div>
                    
                    <div class="vente-info">
                        <div>Prix unitaire: ${item.prixVendu.toFixed(2)} DA</div>
                        <div>Total: <strong>${(item.prixVendu * item.quantite).toFixed(2)} DA</strong></div>
                        <div>B√©n√©fice: <strong>${((item.prixVendu - item.prixAchat) * item.quantite).toFixed(2)} DA</strong></div>
                    </div>
                    
                    <div class="vente-actions">
                        <button class="btn btn-danger delete-item" data-index="${index}" style="font-size:1.2rem"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                container.appendChild(ligne);
            });
            
            document.querySelectorAll('.vente-ligne input[type="number"]').forEach(input => {
                input.addEventListener('change', function() {
                    const index = this.dataset.index;
                    const newQty = parseInt(this.value) || 1;
                    if (newQty < 1) {
                        this.value = 1;
                        panierVente[index].quantite = 1;
                    } else {
                        panierVente[index].quantite = newQty;
                    }
                    renderPanier();
                });
            });
            
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = this.dataset.index;
                    panierVente.splice(index, 1);
                    renderPanier();
                });
            });
            
            updateVenteTotal();
        }
        
        function updateVenteTotal() {
            let total = 0;
            let benefice = 0;
            
            panierVente.forEach(item => {
                total += item.prixVendu * item.quantite;
                benefice += (item.prixVendu - item.prixAchat) * item.quantite;
            });
            
            document.getElementById('total-vente').textContent = total.toFixed(2);
            document.getElementById('benefice-vente').textContent = benefice.toFixed(2);
        }
        
        function viderPanier() {
            if(panierVente.length === 0) return;
            if(confirm('Vider le panier ? Cette action est irr√©versible.')) {
                panierVente = [];
                renderPanier();
            }
        }
        
        function finaliserVente() {
            if(panierVente.length === 0) {
                alert('Le panier est vide');
                return;
            }
            
            let stockOk = true;
            let stockErrors = [];
            
            panierVente.forEach(item => {
                const produit = produits.find(p => p.id === item.id);
                if(!produit) {
                    stockOk = false;
                    stockErrors.push(`Produit "${item.nom}" introuvable dans l'inventaire`);
                    return;
                }
                
                if(produit.stockUnitaires < item.quantite) {
                    stockOk = false;
                    stockErrors.push(`Stock insuffisant pour "${produit.nom}". Stock restant: ${produit.stockUnitaires}`);
                }
            });
            
            if(!stockOk) {
                alert('Erreurs de stock:\n\n' + stockErrors.join('\n'));
                return;
            }
            
            panierVente.forEach(item => {
                const produit = produits.find(p => p.id === item.id);
                if(produit) {
                    produit.stockUnitaires -= item.quantite;
                }
            });
            
            const total = panierVente.reduce((sum, item) => sum + (item.prixVendu * item.quantite), 0);
            const benefice = panierVente.reduce((sum, item) => sum + ((item.prixVendu - item.prixAchat) * item.quantite), 0);
            
            const vente = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                lignes: panierVente.map(item => ({
                    id: item.id,
                    code: item.code,
                    nom: item.nom,
                    prixAchat: item.prixAchat,
                    prixVendu: item.prixVendu,
                    quantite: item.quantite,
                    type: item.type
                })),
                total,
                benefice
            };
            
            ventes.push(vente);
            saveData();
            
            panierVente = [];
            renderPanier();
            updateStats();
            
            alert(`Vente enregistr√©e avec succ√®s !\n\nTotal: ${total.toFixed(2)} DA\nB√©n√©fice: ${benefice.toFixed(2)} DA`);
        }
        
        function renderHistorique() {
            const container = document.getElementById('table-historique');
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Transaction</th>
                            <th>Produit</th>
                            <th>Qt√©</th>
                            <th>Prix unitaire</th>
                            <th>Total</th>
                            <th>B√©n√©fice</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const dateDebut = document.getElementById('date-debut').value;
            const dateFin = document.getElementById('date-fin').value;
            const searchTerm = document.getElementById('rech-historique').value.toLowerCase();
            
            const groupedVentes = {};
            ventes.forEach(vente => {
                const venteDate = vente.date.split('T')[0];
                
                if(dateDebut && venteDate < dateDebut) return;
                if(dateFin && venteDate > dateFin) return;
                
                if (!groupedVentes[vente.id]) {
                    groupedVentes[vente.id] = {
                        date: venteDate,
                        total: vente.total,
                        benefice: vente.benefice,
                        lignes: []
                    };
                }
                
                vente.lignes.forEach(ligne => {
                    const produit = produits.find(p => p.code === ligne.code);
                    if(!produit) return;
                    
                    if(searchTerm && !produit.nom.toLowerCase().includes(searchTerm)) return;
                    
                    groupedVentes[vente.id].lignes.push({
                        nom: ligne.nom,
                        quantite: ligne.quantite,
                        prixVendu: ligne.prixVendu,
                        totalLigne: ligne.prixVendu * ligne.quantite,
                        beneficeLigne: (ligne.prixVendu - ligne.prixAchat) * ligne.quantite
                    });
                });
            });
            
            Object.keys(groupedVentes).forEach(venteId => {
                const vente = groupedVentes[venteId];
                const firstLine = vente.lignes[0];
                
                html += `
                    <tr>
                        <td>${vente.date}</td>
                        <td>${venteId.substring(0, 8)}</td>
                        <td>${firstLine.nom}</td>
                        <td>${firstLine.quantite}</td>
                        <td>${firstLine.prixVendu.toFixed(2)} DA</td>
                        <td>${firstLine.totalLigne.toFixed(2)} DA</td>
                        <td>${firstLine.beneficeLigne.toFixed(2)} DA</td>
                    </tr>
                `;
                
                for (let i = 1; i < vente.lignes.length; i++) {
                    const ligne = vente.lignes[i];
                    html += `
                        <tr>
                            <td></td>
                            <td></td>
                            <td>${ligne.nom}</td>
                            <td>${ligne.quantite}</td>
                            <td>${ligne.prixVendu.toFixed(2)} DA</td>
                            <td>${ligne.totalLigne.toFixed(2)} DA</td>
                            <td>${ligne.beneficeLigne.toFixed(2)} DA</td>
                        </tr>
                    `;
                }
                
                html += `
                    <tr style="background-color: #e0f0ff; font-weight: bold;">
                        <td colspan="4">Total transaction</td>
                        <td colspan="1">${vente.lignes.length} produits</td>
                        <td>${vente.total.toFixed(2)} DA</td>
                        <td>${vente.benefice.toFixed(2)} DA</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
            
            if (Object.keys(groupedVentes).length === 0) {
                container.innerHTML = '<div class="alert alert-info" style="margin-top:20px">Aucune vente trouv√©e pour les crit√®res s√©lectionn√©s</div>';
            }
        }
        
        function openModal(modalId = 'modal') {
            document.getElementById(modalId).classList.add('active');
            currentModal = modalId;
        }
        
        function closeModal(modalId = 'modal') {
            document.getElementById(modalId).classList.remove('active');
            currentModal = null;
        }
    </script>
</body>
</html>
